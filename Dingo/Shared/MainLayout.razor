@inherits LayoutComponentBase

@inject IDisplayNameHandler nameHandler
@inject IStatusHandler statusHandler
@inject IFriendHandler friendHandler

@using DingoDataAccess.Models.Friends

<CascadingValue Value=@TopLevel Name=@nameof(TopLevel)>
    <CascadingValue Value=@Id Name=@nameof(Id)>
        <CascadingValue Value=@DisplayName Name=@nameof(DisplayName)>
            <CascadingValue Value=@MyFriendInfo Name=@nameof(MyFriendInfo)>
                <div class="sidebar">
                    <NavMenu />
                </div>
                <div class="main">
                    <div class="content px-4">
                        @Body
                    </div>
                </div>
                <Dingo.Pages.Components.Toasts />
                <Dingo.Pages.Components.Modals />
                <Dingo.Pages.Account.ChangeAvatar />
                <Dingo.Pages.Account.ChangeUsername />
            </CascadingValue>
        </CascadingValue>
    </CascadingValue>
</CascadingValue>

@code{
    [Parameter]
    public string Id { get; set; }

    [Parameter]
    public string DisplayName { get; set; }

    [Parameter]
    public IFriendModel MyFriendInfo { get; set; }

    public readonly TopLevelObjects TopLevel = new();

    [Parameter]
    public MessageCallbackReference messageCallbackReference { get; set; } = new();

    [CascadingParameter]
    protected Task<AuthenticationState> AuthStat { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        // only get the id and name if its not passed a param as a component
        // this helps reduce the # of requests to the DB
        // check to see if we need to get the display and id to change the name
        if (AuthStat != null)
        {
            await SetUserInfo();

            await SetOnlineStatus();
        }

        TopLevel.StateHasChanged = () => InvokeAsync(() => TopLevelStateChange());

        await SetupTimers();


    }

    protected override async Task OnParametersSetAsync()
    {


        await base.OnParametersSetAsync();
    }

    private async Task SetOnlineStatus()
    {
        var lastStatus = await statusHandler.TryGetLastVirtualStatus(Id);

        // make sure our virtual status is set before our actual status to avoid notfiying other clients
        if (lastStatus.result && lastStatus.status != DingoDataAccess.Enums.OnlineStatus.Offline)
        {
            if (MyFriendInfo.VirtualStatus != lastStatus.status)
            {
                await statusHandler.SetVirtualStatus(Id, lastStatus.status);
                MyFriendInfo.VirtualStatus = lastStatus.status;
            }
        }

        // set the internal status of the user to online
        await statusHandler.SetStatus(Id, DingoDataAccess.Enums.OnlineStatus.Online);

        if (MyFriendInfo != null)
        {
            MyFriendInfo.Status = DingoDataAccess.Enums.OnlineStatus.Online;
        }
    }


    private async Task SetUserInfo()
    {
        // get the auth state from the cascaded param
        var auth = await AuthStat;

        // get the id, it's okay if its null becuase GetDisplayName returns instantly if it's null
        Id = auth?.User?.Claims?.FirstOrDefault()?.Value;

        // get the display name, this should NEVER be null as it's displayed to the user
        DisplayName = Id is null ? "" : await nameHandler.GetDisplayName(Id) ?? "";

        MyFriendInfo = await friendHandler.GetFriend(Id);
    }

    private void TopLevelStateChange()
    {
        StateHasChanged();
    }

    /// <summary>
    /// Sets up all the timers that should run periodically for this user
    /// </summary>
    /// <returns></returns>
    private async Task SetupTimers()
    {
        // get any friends requests peridically
        await TopLevel.AddTimer(15_000, GetFriendRequests, nameof(Dingo.Pages.Account.Requests.ViewRequests));

        // make sure to set the override so when the user manually navigates to the request component they can force a refresh without having to wait
        TopLevel.GetFriendRequests = GetFriendRequests;

        // update the friends list from the server periodically

        await TopLevel.AddTimer(15_000, async () => await GetFriends(), nameof(Dingo.Pages.Account.Friends.DisplayFriends));

        // make sure other objects can force-check for friends
        TopLevel.GetFriends = GetFriends;
    }

    /// <summary>
    /// retrieves waiting friend requests from server and sends a toast notification when they arrive
    /// </summary>
    /// <returns></returns>
    private async Task GetFriendRequests()
    {
        var newRequests = await friendHandler.GetRequests(Id);

        bool changed = false;

        foreach (var item in newRequests)
        {
            // if we already sent a notification this session we shouldn't send another toast
            if (TopLevel.AlreadyPushedRequestIds.Contains(item.Id) is false)
            {
                // since the id wasn't in the list that contains the already pushed toasts send a toast
                TopLevel.toasts.Add(new Data.GeneralModels.ToastModel()
                {
                    Content = $"{item.DisplayName}#{item.UniqueIdentifier} sent you a friend request.",
                    Title = $"Friend Request",
                    Timeout = TimeSpan.FromSeconds(20)
                });

                // add the id to the list so we dont send more toasts about the same notification
                TopLevel.AlreadyPushedRequestIds.Add(item.Id);

                // mark the list as changed so we can push another render to the UI
                changed = true;
            }
        }

        if (changed)
        {
            // since the list changed add it
            TopLevel.FriendRequests = newRequests;
        }

        // the UI is automatically updated when this function is called from the TopLevel
    }

    /// <summary>
    /// Retrieves the friends that the current user has added to their friendlist from the server
    /// </summary>
    /// <returns></returns>
    private async Task GetFriends()
    {
        TopLevel.Friends = await friendHandler.GetFriendList(Id);
    }
}